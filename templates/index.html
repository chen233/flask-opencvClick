<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>工作流管理</title>
    <style>
        /* 简单样式，可根据需求美化 */
        .config-area, .button-area, .log-area {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-content {
            height: 300px;
            overflow-y: auto;
            border: 1px dashed #aaa;
            padding: 5px;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 定时执行时间配置 -->
    <div class="config-area">
        <h3>定时执行时间</h3>
        <div>
            <label>A组开始:</label>
            <input type="time" id="time1" value="00:00">
        </div>
        <div>
            <label>A组停止:</label>
            <input type="time" id="time2" value="00:00">
        </div>
        <div>
            <label>B组开始:</label>
            <input type="time" id="time3" value="00:00">
        </div>

        <div>
            <label>B组停止:</label>
            <input type="time" id="time4" value="00:00">
        </div>
    </div>

    <!-- 在定时执行时间配置后添加 -->
    <div class="config-area">
        <h3>定时关机设置</h3>
        <div>
            <label>关机时间:</label>
            <input type="time" id="shutdownTime" value="23:59">
        </div>
    </div>

    <!-- 在工作流控制按钮区域添加 -->
    <button id="setShutdown">设置定时关机</button>
    <button id="cancelShutdown">取消定时关机</button>


    <!-- 工作流控制按钮 -->
    <div class="button-area">
        <button id="startWorkflow">开始工作流</button>
        <button id="stopWorkflow">停止工作流</button>
        <button id="saveConfig">保存配置</button>
    </div>


    <!-- 状态和日志 -->
    <div class="log-area">
        <h3>状态和日志</h3>
        <div class="log-content" id="logContent"></div>
        <div>当前状态: <span id="currentStatus">未运行</span></div>
    </div>


<script>
    window.onload = function() {
    // 页面加载时立即获取状态
    fetchStatus();
    // 定时刷新状态（每5秒）
    setInterval(fetchStatus, 5000);
    // 初始加载日志
    loadLogs();
    // 定时刷新日志（每3秒）
    setInterval(loadLogs, 3000);
};
let isFirstLoad = true;

// 单独封装获取状态的函数
function fetchStatus() {
    fetch('/api/get_status')
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // 更新关机时间输入框
                const shutdownTimeInput = document.getElementById('shutdownTime');
                if (shutdownTimeInput && data.config.shutdown_time) {
                    // 首次加载时设置值，或者输入框为空且不是用户正在编辑时更新
                    if (isFirstLoad || (shutdownTimeInput.value.trim() === '' && !shutdownTimeInput.matches(':focus'))) {
                        shutdownTimeInput.value = data.config.shutdown_time;
                    }
                }
                // 更新状态显示区域
                const statusDiv = document.getElementById('currentStatus');
                if (statusDiv) {
                    // 保存原始状态文本（不含关机信息）
                    const baseStatusText = statusDiv.textContent.replace(/ \(已设置定时关机: .*\)/, '');

                    // 根据状态更新显示
                    if (data.shutdown_scheduled) {
                        statusDiv.textContent = `${baseStatusText} (已设置定时关机: ${data.config.shutdown_time})`;
                    } else {
                        statusDiv.textContent = baseStatusText;
                    }
                }

                // 更新按钮状态
                const setBtn = document.getElementById('setShutdown');
                const cancelBtn = document.getElementById('cancelShutdown');

                if (setBtn && cancelBtn) {
                    if (data.shutdown_scheduled) {
                        setBtn.disabled = true;
                        cancelBtn.disabled = false;
                        setBtn.textContent = "已设置定时关机";
                    } else {
                        setBtn.disabled = false;
                        cancelBtn.disabled = true;
                        setBtn.textContent = "设置定时关机";
                    }
                }

                // 首次加载完成后更新标记
                if (isFirstLoad) {
                    isFirstLoad = false;
                }
            } else {
                console.error('获取状态失败:', data.message);
            }
        })
        .catch(error => {
            console.error('获取状态出错:', error);
        });
}

// 更新状态显示的函数
function updateStatus(isRunning) {
    const statusDiv = document.getElementById('currentStatus');
    if (isRunning) {
        statusDiv.textContent = '工作流运行中...';
        statusDiv.className = 'status running';
    } else {
        statusDiv.textContent = '工作流已停止';
        statusDiv.className = 'status stopped';
    }
}

        // Ajax 调用后端接口（示例：开始工作流）
        document.getElementById("startWorkflow").addEventListener("click", function() {
            fetch("/api/start_workflow", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("currentStatus").textContent = "工作流运行中...";
                    appendLog("工作流已启动");
                } else {
                    appendLog("启动失败: " + data.message);
                }
            })
            .catch(error => {
                appendLog("请求错误: " + error);
            });
        });

        // 停止工作流
        document.getElementById("stopWorkflow").addEventListener("click", function() {
            fetch("/api/stop_workflow", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("currentStatus").textContent = "已停止";
                    appendLog("工作流已停止");
                } else {
                    appendLog("停止失败: " + data.message);
                }
            })
            .catch(error => {
                appendLog("请求错误: " + error);
            });
        });

        // 保存配置
        document.getElementById("saveConfig").addEventListener("click", function() {
            const times = {
                time1: document.getElementById("time1").value,
                time2: document.getElementById("time2").value,
                time3: document.getElementById("time3").value,
                time4: document.getElementById("time4").value
            };
            fetch("/api/save_config", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(times)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appendLog("配置保存成功");
                } else {
                    appendLog("配置保存失败: " + data.message);
                }
            })
            .catch(error => {
                appendLog("请求错误: " + error);
            });
        });

        // 追加日志到页面
        function appendLog(message) {
            const logDiv = document.getElementById("logContent");
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight; // 滚动到底部
        }

        // 轮询获取日志（模拟实时日志）
        setInterval(() => {
            fetch("/api/get_log")
            .then(response => response.json())
            .then(data => {
                data.logs.forEach(log => appendLog(log));
            })
            .catch(error => console.error("获取日志失败:", error));
        }, 2000);

        // 设置定时关机
        document.getElementById("setShutdown").addEventListener("click", function() {
            const time = document.getElementById("shutdownTime").value;
            if (!time) {
                appendLog("请选择关机时间");
                return;
            }

            fetch("/api/set_shutdown", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ time: time })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appendLog(`定时关机已设置为 ${time}`);
                } else {
                    appendLog("设置定时关机失败: " + data.message);
                }
                // 操作完成后立即同步状态
                fetchStatus();
            })
            .catch(error => {
                appendLog("请求错误: " + error);
            });
        });

        // 取消定时关机
        document.getElementById("cancelShutdown").addEventListener("click", function() {
            fetch("/api/cancel_shutdown", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appendLog("定时关机已取消");
                } else {
                    appendLog("取消定时关机失败: " + data.message);
                }
                // 操作完成后立即同步状态
                fetchStatus();
            })
            .catch(error => {
                appendLog("请求错误: " + error);
            });
        });

        // 定时刷新状态（每30秒）
        setInterval(fetchStatus, 30000);

        // 页面加载时立即获取一次状态
        window.addEventListener('load', fetchStatus);


</script>
</body>
</html>